<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DESPERTAR ESTELAR: FUGA OU SALVAÇÃO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background-color: #000;
            color: #00ff00;
            overflow: hidden;
            touch-action: manipulation;
            height: 100vh;
            width: 100vw;
        }

        /* TELAS PRINCIPAIS */
        .screen {
            position: absolute;
            height: 100vh;
            width: 100vw;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s;
            padding: 20px;
            overflow: hidden;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* TELA INICIAL */
        #start-screen {
            background-color: #000;
            z-index: 10;
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }

        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
            }
        }

        .title {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            letter-spacing: 3px;
            animation: pulse 3s infinite;
            max-width: 90%;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 10px;
            z-index: 5;
        }

        @keyframes pulse {
            0%, 100% {
                text-shadow: 0 0 10px #00ff00;
            }
            50% {
                text-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00;
            }
        }

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            z-index: 5;
        }

        .start-button {
            padding: 15px 40px;
            font-size: 1.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            border: 2px solid #00ff00;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            width: 250px;
            text-align: center;
        }

        .start-button:hover, .start-button:active {
            background-color: #00ff00;
            color: #000;
            box-shadow: 0 0 20px #00ff00;
        }

        /* Animação do Satélite - Mais Lenta */
        .satellite {
            position: absolute;
            width: 80px;
            height: 40px;
            animation: orbitPlanet 45s linear infinite;
            opacity: 0.8;
            z-index: 3;
        }

        @keyframes orbitPlanet {
            0% {
                transform: translate(-100px, 200px);
            }
            25% {
                transform: translate(calc(100vw - 100px), 100px);
            }
            50% {
                transform: translate(calc(100vw + 100px), 300px);
            }
            75% {
                transform: translate(100px, 400px);
            }
            100% {
                transform: translate(-100px, 200px);
            }
        }

        /* Cometa */
        .comet {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.8),
                        0 0 20px 10px rgba(255, 255, 255, 0.4),
                        -30px 0 30px 15px rgba(255, 255, 255, 0.2);
            animation: cometFly 15s linear infinite;
            opacity: 0;
            z-index: 2;
        }

        @keyframes cometFly {
            0% {
                transform: translate(-100px, 50px);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translate(calc(100vw + 100px), 300px);
                opacity: 0;
            }
        }

        /* Animação do Planeta */
        .planet {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #0077ff, #000066 60%);
            box-shadow: 0 0 50px rgba(0, 119, 255, 0.4);
            z-index: 1;
            top: 70%;
            left: 70%;
            transform: translate(-50%, -50%);
        }

        /* TELA DE INTRO (TEXTO ROLANDO) */
        #intro-screen {
            justify-content: flex-start;
            perspective: 400px;
            background-color: #000;
        }

        .intro-text {
            transform-origin: center bottom;
            transform: rotateX(25deg) translateY(100vh);
            font-size: 1.8rem;
            line-height: 1.5;
            text-align: center;
            max-width: 80%;
            animation: scrollUp 60s linear forwards;
            animation-play-state: running;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #ffff99;
            text-shadow: 0 0 10px #ffff00;
        }

        @keyframes scrollUp {
            from {
                transform: rotateX(25deg) translateY(100vh);
            }
            to {
                transform: rotateX(25deg) translateY(-300vh);
            }
        }

        .skip-intro {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }

        .skip-intro:hover {
            background-color: rgba(0, 50, 0, 0.9);
        }

        .intro-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .intro-control {
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            cursor: pointer;
        }

        .intro-control:hover {
            background-color: rgba(0, 50, 0, 0.9);
        }

        /* TELA DE HISTÓRIA */
        #story-screen {
            justify-content: flex-start;
            overflow-y: auto;
            background-color: #000;
        }

        .story-container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
        }

        .story-text {
            font-size: 1.2rem;
            line-height: 1.5;
            margin-bottom: 2rem;
            text-align: justify;
            animation: fadeIn 2s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .story-id {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 1rem;
            color: #888;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto;
        }

        .option-button {
            padding: 15px;
            background-color: rgba(0, 50, 0, 0.7);
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .option-button:hover, .option-button:active {
            background-color: rgba(0, 80, 0, 0.9);
            box-shadow: 0 0 10px #00ff00;
        }

        .game-menu {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
        }

        .menu-button {
            padding: 8px 15px;
            background-color: rgba(0, 30, 0, 0.8);
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .menu-button:hover {
            background-color: rgba(0, 60, 0, 0.9);
        }

        .menu-dropdown {
            position: absolute;
            top: 40px;
            left: 0;
            background-color: rgba(0, 20, 0, 0.9);
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 10px;
            display: none;
        }

        .menu-dropdown.active {
            display: block;
        }

        .menu-item {
            padding: 8px 15px;
            color: #00ff00;
            cursor: pointer;
            white-space: nowrap;
        }

        .menu-item:hover {
            background-color: rgba(0, 80, 0, 0.7);
        }

        /* TELA DE COMBATE */
        #combat-screen {
            background-color: rgba(50, 0, 0, 0.8);
        }

        .combat-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
        }

        .combat-header {
            text-align: center;
            font-size: 1.5rem;
            color: #ff3333;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ff0000;
        }

        .combat-area {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }

        .combat-character, .combat-enemy {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #666;
            border-radius: 10px;
            padding: 15px;
            width: 48%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .health-bar {
            width: 100%;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background-color: #ff3333;
            width: 100%;
            transition: width 0.5s;
        }

        .combat-log {
            background-color: rgba(0, 0, 0, 0.5);
            border: 1px solid #666;
            border-radius: 10px;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .combat-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .combat-button {
            padding: 10px 20px;
            background-color: rgba(100, 0, 0, 0.7);
            color: white;
            border: 1px solid #ff3333;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .combat-button:hover, .combat-button:active {
            background-color: rgba(150, 0, 0, 0.9);
            box-shadow: 0 0 10px #ff3333;
        }

        /* TELA DE QUEBRA-CABEÇA */
        #puzzle-screen {
            background-color: rgba(0, 0, 50, 0.8);
        }

        .puzzle-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
        }

        .puzzle-header {
            text-align: center;
            font-size: 1.5rem;
            color: #33ccff;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #33ccff;
        }

        .puzzle-description {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #eee;
        }

        .puzzle-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .puzzle-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .puzzle-button {
            padding: 15px 30px;
            background-color: rgba(0, 0, 100, 0.7);
            color: white;
            border: 1px solid #33ccff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
        }

        .puzzle-button:hover, .puzzle-button:active {
            background-color: rgba(0, 0, 150, 0.9);
            box-shadow: 0 0 10px #33ccff;
        }

        #history-screen {
            justify-content: flex-start;
            overflow-y: auto;
        }

        .history-container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding: 20px;
            position: relative;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
        }

        .history-title {
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 20px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }

        .history-entry {
            padding: 10px;
            background-color: rgba(0, 30, 0, 0.5);
            border-radius: 5px;
            border-left: 3px solid #00ff00;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .history-entry:hover {
            background-color: rgba(0, 60, 0, 0.7);
        }

        .back-button {
            padding: 10px 20px;
            background-color: rgba(0, 30, 0, 0.7);
            color: #00ff00;
            border: 1px solid #00ff00;
            border-radius: 5px;
            cursor: pointer;
            align-self: center;
            margin-top: 20px;
        }

        .back-button:hover {
            background-color: rgba(0, 60, 0, 0.9);
        }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .title {
                font-size: 1.8rem;
            }
            
            .intro-text {
                font-size: 1.2rem;
            }
            
            .story-text {
                font-size: 1rem;
            }
            
            .combat-area {
                flex-direction: column;
            }
            
            .combat-character, .combat-enemy {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .title {
                font-size: 1.5rem;
            }
            
            .start-button {
                padding: 10px 30px;
                font-size: 1.2rem;
            }
            
            .intro-text {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- TELA INICIAL -->
    <div id="start-screen" class="screen">
        <div class="stars" id="stars-container"></div>
        <div class="comet"></div>
        <div class="planet"></div>
        <div class="satellite">
            <svg viewBox="0 0 100 50" xmlns="http://www.w3.org/2000/svg">
                <rect x="30" y="15" width="40" height="20" fill="#888" stroke="#aaa" stroke-width="1"/>
                <rect x="10" y="20" width="20" height="10" fill="#666" stroke="#aaa" stroke-width="1"/>
                <rect x="70" y="20" width="20" height="10" fill="#666" stroke="#aaa" stroke-width="1"/>
                <rect x="40" y="5" width="20" height="10" fill="#555" stroke="#aaa" stroke-width="1"/>
                <rect x="45" y="0" width="10" height="5" fill="#33ccff" stroke="#00ffff" stroke-width="1"/>
                <rect x="45" y="35" width="10" height="5" fill="#33ccff" stroke="#00ffff" stroke-width="1"/>
            </svg>
        </div>
        <h1 class="title">DESPERTAR ESTELAR:<br>FUGA OU SALVAÇÃO</h1>
        <div class="start-buttons">
            <button class="start-button" id="start-button">Iniciar</button>
            <button class="start-button" id="continue-button" disabled>Continuar</button>
            <button class="start-button" id="skip-to-story">Pular Prólogo</button>
        </div>
    </div>

    <!-- TELA DE INTRODUÇÃO (TEXTO ROLANDO) -->
    <div id="intro-screen" class="screen hidden">
        <div class="intro-text" id="intro-text">
            <p>Em um futuro distante, onde a humanidade conquistou as estrelas...</p>
            <br>
            <p>A nave colonial Esperança viaja pelos confins do espaço, transportando 200 colonos em criossono para o sistema Kepler-62.</p>
            <br>
            <p>Sua missão: estabelecer a primeira colônia humana permanente fora do Sistema Solar.</p>
            <br>
            <p>O que deveria ser apenas mais um salto hiperespacial rotineiro se transforma em uma luta desesperada pela sobrevivência.</p>
            <br>
            <p>Quando algo dá terrivelmente errado...</p>
            <br>
            <p>Capitão Alex Reiner acorda em uma nave danificada, com sistemas falhando e um mistério mortal por resolver.</p>
            <br>
            <p>Salvar os colonos ou salvar a si mesmo?</p>
            <br>
            <p>A escolha está em suas mãos...</p>
        </div>
        <button class="skip-intro" id="skip-intro-button">Pular Introdução</button>
        <div class="intro-controls">
            <button class="intro-control" id="pause-intro">Pausar</button>
            <button class="intro-control" id="resume-intro" style="display: none;">Continuar</button>
        </div>
    </div>

    <!-- TELA DE HISTÓRIA -->
    <div id="story-screen" class="screen hidden">
        <div class="game-menu">
            <button class="menu-button" id="menu-button">Menu</button>
            <div class="menu-dropdown" id="menu-dropdown">
                <div class="menu-item" id="save-game">Salvar Jogo</div>
                <div class="menu-item" id="load-game">Carregar Jogo</div>
                <div class="menu-item" id="view-history">Ver Histórico</div>
                <div class="menu-item" id="main-menu">Menu Principal</div>
            </div>
        </div>
        <div class="story-container" id="story-container">
            <span class="story-id" id="section-id"></span>
            <div class="story-text" id="story-text"></div>
            <div class="options-container" id="options-container"></div>
        </div>
    </div>

    <!-- TELA DE HISTÓRICO -->
    <div id="history-screen" class="screen hidden">
        <div class="history-container" id="history-container">
            <h2 class="history-title">Histórico da Jornada</h2>
            <div id="history-entries"></div>
            <button class="back-button" id="back-from-history">Voltar à História</button>
        </div>
    </div>

    <!-- TELA DE COMBATE -->
    <div id="combat-screen" class="screen hidden">
        <div class="combat-container">
            <h2 class="combat-header" id="combat-header">COMBATE</h2>
            <div class="combat-area">
                <div class="combat-character">
                    <h3 id="character-name">Capitão Reiner</h3>
                    <div class="health-bar">
                        <div class="health-fill" id="character-health"></div>
                    </div>
                    <div id="character-items">Arma: Pistola de Energia</div>
                </div>
                <div class="combat-enemy">
                    <h3 id="enemy-name">Inimigo</h3>
                    <div class="health-bar">
                        <div class="health-fill" id="enemy-health"></div>
                    </div>
                    <div id="enemy-info"></div>
                </div>
            </div>
            <div class="combat-log" id="combat-log">
                Prepare-se para o combate!
            </div>
            <div class="combat-actions" id="combat-actions">
                <!-- Botões serão adicionados via JavaScript -->
            </div>
        </div>
    </div>

    <!-- TELA DE QUEBRA-CABEÇA -->
    <div id="puzzle-screen" class="screen hidden">
        <div class="puzzle-container">
            <h2 class="puzzle-header" id="puzzle-header">QUEBRA-CABEÇA</h2>
            <p class="puzzle-description" id="puzzle-description"></p>
            <div class="puzzle-content" id="puzzle-content">
                <!-- Conteúdo do quebra-cabeça será adicionado via JavaScript -->
            </div>
            <div class="puzzle-options" id="puzzle-options">
                <!-- Opções serão adicionadas via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // -------------------- CONFIGURAÇÕES DO JOGO --------------------
        const SCROLL_SPEED = 60; // Velocidade do texto rolando em segundos
        const GAME_VERSION = "1.0.4";
        const SAVE_KEY = "despertarEstelar_saveData";
        const DEBUG_MODE = true; // Ativar para ver mensagens de debugging no console
        
        // -------------------- DADOS DO JOGO --------------------
        // Definição das seções da história
        const storyData = {
            "intro": {
                text: "Seus olhos se abrem com dificuldade, a visão turva tentando se adaptar à fraca iluminação vermelha de emergência. Sua cabeça lateja como se tivesse sido atingida por um meteoro. As memórias retornam aos poucos: você é o Capitão Alex Reiner da nave colonial Esperança, transportando 200 colonos em criossono para o sistema Kepler-62. O último salto hiperespacial deveria ter sido rotineiro, mas algo deu muito errado.\n\nO painel de controle à sua frente pisca com dezenas de alertas. Uma voz robótica anuncia friamente: \"Falha crítica no núcleo. Colapso estrutural em 120 minutos. Evacuação recomendada.\"\n\nVocê se levanta cambaleante da cadeira do piloto e percebe que está sozinho na ponte. A tripulação deveria estar aqui. Suas opções são limitadas e o tempo, precioso.\n\nO que você faz?",
                options: [
                    { text: "Verificar o sistema de diagnóstico para entender o que aconteceu.", nextSection: "10" },
                    { text: "Ir imediatamente ao setor de criogenia para verificar os passageiros.", nextSection: "20" },
                    { text: "Dirigir-se à sala de comunicações para enviar um pedido de socorro.", nextSection: "30" }
                ]
            },
            "10": {
                text: "O sistema de diagnóstico está parcialmente operacional. Seus dedos deslizam pelo painel holográfico enquanto você navega pelos relatórios técnicos. A situação é pior do que imaginava: durante o salto, uma anomalia quântica causou uma sobrecarga no núcleo de fusão. O sistema de contenção está falhando e o colapso é inevitável.\n\nAs câmeras de segurança mostram vários setores já comprometidos. O setor oeste está completamente lacrado devido à descompressão. No relatório da tripulação, descobre que dos 15 tripulantes, apenas 8 estão vivos, espalhados pela nave e alguns feridos. Os 200 colonos em criossono estão em risco crítico - o sistema de suporte vital está operando com energia de emergência.\n\nUm detalhe chama sua atenção: há apenas 2 cápsulas de escape operacionais, cada uma com capacidade para 50 pessoas.\n\nO que você faz?",
                options: [
                    { text: "Acessar o mapa da nave para planejar uma rota de resgate.", nextSection: "11" },
                    { text: "Verificar o sistema de comunicação interna para contatar sobreviventes.", nextSection: "12" },
                    { text: "Examinar o registro do salto para entender melhor a anomalia.", nextSection: "13" }
                ]
            },
            "11": {
                text: "O mapa holográfico da nave surge diante de você. A Esperança tem 5 níveis principais, com você atualmente na ponte (nível 1). O setor de criogenia está no nível 3, as cápsulas de escape no nível 5, e a sala do reator no nível 4.\n\nRotas diretas entre níveis estão bloqueadas em vários pontos. Será necessário um desvio pelo sistema de manutenção para alcançar qualquer setor crucial.\n\nEnquanto analisa as opções, uma nova mensagem aparece no sistema: \"Detectada atividade não autorizada no setor de segurança. Protocolo de quarentena ativado.\"\n\nIsso não estava no diagnóstico inicial. Alguém ou algo está mexendo nos sistemas de segurança.\n\nO que você faz?",
                options: [
                    { text: "Investigar a atividade suspeita no setor de segurança.", nextSection: "14" },
                    { text: "Ignorar o alerta e seguir para o setor de criogenia.", nextSection: "20" },
                    { text: "Ativar os protocolos de emergência que darão mais tempo antes do colapso.", nextSection: "15" }
                ]
            },
            "12": {
                text: "Você ativa o sistema de comunicação interna. \"Aqui é o Capitão Reiner. Alguém na escuta?\"\n\nApós alguns segundos de estática, uma voz feminina responde: \"Capitão? Graças a Deus! É Elena Vasquez, engenheira-chefe. Estou presa na sala de máquinas auxiliar com o Dr. Petrov. Ele está ferido.\"\n\nOutra voz corta a transmissão: \"Capitão, aqui é Tenente Rodriguez. Estou com três outros tripulantes no laboratório. Tentamos acessar o setor de criogenia, mas o sistema está em lockdown.\"\n\nUma terceira voz, distorcida e entrecortada: \"...sabotagem...não confie...eles querem...\" A transmissão é cortada abruptamente.\n\nO que você faz?",
                options: [
                    { text: "Pedir mais informações à Engenheira Vasquez.", nextSection: "16" },
                    { text: "Solicitar um relatório detalhado ao Tenente Rodriguez.", nextSection: "17" },
                    { text: "Tentar restaurar a última transmissão cortada.", nextSection: "18" }
                ]
            },
            "13": {
                text: "Os registros do salto são confusos. Algo interferiu com os cálculos quânticos no momento exato da transição. A assinatura energética não parece natural -- os padrões sugerem uma interferência deliberada.\n\nUma entrada do diário de bordo, datada de apenas 12 horas antes do salto, chama sua atenção. É do Oficial de Ciências, Dr. Yamamoto: \"Descobri algo preocupante nos dados de longa distância. Preciso falar com o Capitão imediatamente. Se minhas suspeitas estiverem corretas, não estamos sozinhos nesta missão.\"\n\nAo verificar os registros de acesso, você descobre que alguém entrou na sala de controle do salto três minutos antes da inicialização, usando as credenciais do Oficial de Segurança Chen.\n\nO que você faz?",
                options: [
                    { text: "Verificar as câmeras de segurança para ver quem entrou na sala de controle.", nextSection: "19" },
                    { text: "Procurar o Oficial de Segurança Chen pela nave.", nextSection: "21" },
                    { text: "Investigar o último local conhecido do Dr. Yamamoto.", nextSection: "22" }
                ]
            },
            "18": {
                text: "Você utiliza ferramentas avançadas de análise de áudio para reconstruir a transmissão cortada. Depois de alguns ajustes, consegue recuperar parte da mensagem:\n\n\"...sabotagem confirmada. Não confie na Vasquez. Eles querem os dados do projeto Prometeu. Os passageiros são apenas disfarce. O verdadeiro objetivo é o módulo secreto. Capitão, você precisa acessar o compartimento 772B antes que eles destruam...\"\n\nA mensagem termina aí. Não há identificação de quem a enviou.\n\nVocê verifica rapidamente sua base de dados pessoal. O projeto Prometeu está classificado como ultra-secreto, algo que apenas capitães de alto escalão deveriam conhecer. Envolve tecnologia de terraformação revolucionária.\n\nO compartimento 772B não aparece em nenhum mapa oficial da nave.\n\nO que você faz?",
                options: [
                    { text: "Confrontar Elena Vasquez sobre a mensagem.", nextSection: "36" },
                    { text: "Procurar o misterioso compartimento 772B.", nextSection: "37" },
                    { text: "Ignorar a mensagem, considerando-a uma possível armadilha.", nextSection: "38" }
                ]
            },
            "36": {
                text: "Você reestabelece contato com Elena Vasquez. Desta vez, sua voz é fria e calculada: \"Engenheira Vasquez, acabo de interceptar uma mensagem muito interessante sobre você. Algo sobre não confiar em você e o Projeto Prometeu. Gostaria de explicar?\"\n\nO silêncio que segue é perturbador. Finalmente, Elena responde, sua voz completamente diferente - sem o nervosismo anterior, apenas eficiência clínica:\n\n\"Impressionante, Capitão. Esperava ter mais tempo antes que descobrisse. Sim, tenho interesse no Prometeu, mas não sou sua inimiga. A verdade é mais complexa.\"\n\n\"Nova Terra não é o que pensam. Descobrimos que a Aliança planeja usar o Prometeu como arma, não como ferramenta de terraformação. Estou aqui para impedir isso.\"\n\n\"Petrov não sabe minha verdadeira identidade. Ele é apenas um peão, assim como você seria. Mas agora precisamos colaborar ou todos morreremos.\"\n\nO que você faz?",
                options: [
                    { text: "Fingir acreditar nela para obter mais informações.", nextSection: "94" },
                    { text: "Confrontá-la abertamente, exigindo toda a verdade.", nextSection: "95" },
                    { text: "Encerrar a comunicação e procurar o compartimento 772B sozinho.", nextSection: "96" }
                ]
            },
            "37": {
                text: "Decidido a encontrar o misterioso compartimento 772B, você consulta os esquemas detalhados da nave. Curiosamente, esta seção não aparece em nenhum mapa oficial, mas cruzando informações de consumo de energia e rotas de manutenção, você identifica uma anomalia.\n\nHá um espaço não contabilizado entre o armazém principal e o setor de pesquisa no nível 4. Seguindo seu instinto, você se dirige para lá.\n\nO caminho é perigoso - várias seções sofreram danos estruturais. Ao chegar ao local aproximado, você encontra apenas uma parede lisa sem entradas visíveis. No entanto, seu scanner detecta um campo energético anômalo.\n\nExaminando mais detalhadamente, você percebe um pequeno painel oculto. Ao ativá-lo, uma interface de segurança solicita credenciais de nível máximo e uma sequência biométrica.",
                options: [
                    { text: "Tentar usar suas credenciais de capitão.", nextSection: "97" },
                    { text: "Tentar contornar o sistema de segurança hackeando-o.", nextSection: "98" },
                    { text: "Procurar alguém com autorização adequada, como o Dr. Yamamoto.", nextSection: "99" }
                ]
            },
            "38": {
                text: "Você decide ignorar a mensagem enigmática. Poderia ser uma armadilha para desviá-lo de sua missão principal: salvar os colonos e a tripulação restante.\n\nO núcleo continua em deterioração e o tempo é essencial. Consultando o mapa da nave, você traça a rota mais eficiente para o setor de criogenia, onde os 200 colonos permanecem vulneráveis em sono profundo.\n\nNo caminho, seu comunicador capta uma transmissão fragmentada - são coordenadas espaciais seguidas por uma contagem regressiva. Algo vai acontecer em menos de 60 minutos, além do colapso previsto da nave.\n\nReferências ao \"Prometeu\" continuam surgindo. Seja lá o que for, parece central neste mistério.\n\nO que você faz?",
                options: [
                    { text: "Manter o curso para o setor de criogenia, ignorando as distrações.", nextSection: "20" },
                    { text: "Investigar as coordenadas espaciais recebidas.", nextSection: "100" },
                    { text: "Reconsiderar e procurar informações sobre o Projeto Prometeu nos bancos de dados da nave.", nextSection: "101" }
                ]
            },
            // Outras seções da história...
            "final": {
                text: "À medida que você pilota a nave de fuga através dos destroços da Esperança, olha pela janela uma última vez. A enorme estrutura que foi seu lar por tanto tempo agora se desintegra em uma explosão silenciosa no vácuo do espaço.\n\nNa cabine atrás de você, os sobreviventes que conseguiu resgatar - uma mistura de tripulantes e colonos despertados - observam em silêncio. Alguns choram, outros simplesmente encaram o vazio, processando o trauma e a perda.\n\nO módulo Prometeu está seguro, seja para ser destruído ou entregue às autoridades adequadas, dependendo das escolhas que você fez. A verdade sobre a sabotagem e os impostores veio à tona, embora a um custo terrível.\n\nNo painel de navegação, as coordenadas da estação mais próxima piscam - está a três semanas de distância no espaço normal. Uma viagem longa com recursos limitados, mas há esperança.\n\nEnquanto a nave acelera para longe dos destroços, você reflete sobre as decisões que tomou, as vidas que conseguiu salvar e aquelas que teve que deixar para trás. Algumas escolhas o assombrarão para sempre, outras trarão um senso de dever cumprido.\n\nUma coisa é certa: nada será como antes. E enquanto as estrelas se estendem infinitas à sua frente, você se pergunta o que o futuro reserva para os sobreviventes da Esperança.\n\nFIM DA AVENTURA",
                options: [
                    { text: "Jogar novamente", nextSection: "intro" }
                ]
            }
        };

        // Adicionar seções de fallback para garantir que todas as opções levem a algum lugar
        function addFallbackSections() {
            for (let sectionId in storyData) {
                if (storyData[sectionId].options) {
                    storyData[sectionId].options.forEach(option => {
                        if (!storyData[option.nextSection] && option.nextSection !== "final") {
                            storyData[option.nextSection] = {
                                text: `[Continuando a história...] Você tomou a decisão de ${option.text.toLowerCase()}. O caminho à frente apresenta novos desafios enquanto você navega pela nave danificada.\n\nAo avançar, você reflete sobre o que descobriu até agora sobre o Projeto Prometeu, os agentes infiltrados e o destino dos colonos.\n\nSua missão continua, com o tempo se esgotando rapidamente.`,
                                options: [
                                    { text: "Continuar explorando a nave", nextSection: "10" },
                                    { text: "Verificar o setor de criogenia", nextSection: "20" },
                                    { text: "Buscar o compartimento 772B", nextSection: "37" }
                                ]
                            };
                            console.log(`Criada seção de fallback para ${option.nextSection}`);
                        }
                    });
                }
            }
        }

        // -------------------- ITENS DO JOGO (ALEATÓRIOS) --------------------
        const randomWeapons = [
            "Pistola de Plasma", 
            "Rifle de Pulso", 
            "Lança-Dardos Tranquilizantes", 
            "Bastão de Choque", 
            "Canhão Sônico"
        ];
        
        const randomItems = [
            "Kit Médico Avançado", 
            "Injetor de Adrenalina", 
            "Escudo Pessoal", 
            "Módulo de Camuflagem", 
            "Granada de Choque", 
            "Ferramenta Multiuso"
        ];
        
        const randomEnemies = [
            "Agente de Nova Terra", 
            "Sabotador Infiltrado", 
            "Segurança Corrompido", 
            "Mercenário Contratado"
        ];

        // -------------------- VARIÁVEIS GLOBAIS --------------------
        let currentSection = "intro";
        let introAnimationPaused = false;
        let textScrollTimeout;
        let gameHistory = [];
        let menuOpen = false;
        let audioEnabled = true;

        // -------------------- FUNÇÕES DE UTILITÁRIO --------------------
        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        function showScreen(screenId) {
            console.log(`Mostrando tela: ${screenId}`);
            
            // Esconder todas as telas
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Mostrar a tela solicitada
            document.getElementById(screenId).classList.remove('hidden');
        }

        function saveGame() {
            const saveData = {
                currentSection: currentSection,
                gameHistory: gameHistory,
                gameVersion: GAME_VERSION
            };
            
            localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
            alert("Jogo salvo com sucesso!");
        }
        
        function loadGame() {
            const saveData = localStorage.getItem(SAVE_KEY);
            
            if (!saveData) {
                alert("Nenhum jogo salvo encontrado!");
                return false;
            }
            
            try {
                const data = JSON.parse(saveData);
                
                if (data.gameVersion !== GAME_VERSION) {
                    if (!confirm("O jogo salvo é de uma versão diferente. Carregar mesmo assim?")) {
                        return false;
                    }
                }
                
                currentSection = data.currentSection;
                gameHistory = data.gameHistory || [];
                
                loadSection(currentSection);
                return true;
            } catch (e) {
                alert("Erro ao carregar o jogo: " + e.message);
                return false;
            }
        }
        
        function addToHistory(sectionId, text) {
            // Limitar o histórico a 20 entradas para evitar sobrecarga
            if (gameHistory.length >= 20) {
                gameHistory.shift();
            }
            
            gameHistory.push({
                sectionId: sectionId,
                text: text.substring(0, 100) + (text.length > 100 ? "..." : "")
            });
        }
        
        function showHistory() {
            const historyEntries = document.getElementById('history-entries');
            historyEntries.innerHTML = '';
            
            if (gameHistory.length === 0) {
                historyEntries.innerHTML = '<div class="history-entry">Nenhuma entrada no histórico ainda.</div>';
                return;
            }
            
            gameHistory.forEach((entry, index) => {
                const entryElement = document.createElement('div');
                entryElement.classList.add('history-entry');
                entryElement.textContent = `${index + 1}. ${entry.text}`;
                entryElement.addEventListener('click', () => {
                    if (confirm(`Voltar para esta parte da história? (Seção ${entry.sectionId})`)) {
                        loadSection(entry.sectionId);
                    }
                });
                historyEntries.appendChild(entryElement);
            });
            
            showScreen('history-screen');
        }
        
        // -------------------- GERADORES DE ESTRELAS --------------------
        function generateStars() {
            const starsContainer = document.getElementById('stars-container');
            if (!starsContainer) return;
            
            // Limpar estrelas existentes
            starsContainer.innerHTML = '';
            
            const numberOfStars = 200;
            
            for (let i = 0; i < numberOfStars; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const size = Math.random() * 3;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 2}s`;
                starsContainer.appendChild(star);
            }
        }
        
        // -------------------- HANDLERS DA TELA INICIAL --------------------
        function setupStartScreen() {
            generateStars();
            
            const startButton = document.getElementById('start-button');
            const continueButton = document.getElementById('continue-button');
            const skipButton = document.getElementById('skip-to-story');
            
            if (startButton) {
                startButton.addEventListener('click', function() {
                    showScreen('intro-screen');
                    startIntroAnimation();
                });
            }

            if (continueButton) {
                continueButton.addEventListener('click', function() {
                    if (!loadGame()) {
                        alert("Não foi possível carregar o jogo salvo.");
                    }
                });
            }

            if (skipButton) {
                skipButton.addEventListener('click', function() {
                    showScreen('story-screen');
                    loadSection('intro');
                });
            }
        }
        
        // -------------------- HANDLERS DA ANIMAÇÃO INTRODUTÓRIA --------------------
        function startIntroAnimation() {
            const introText = document.getElementById('intro-text');
            if (!introText) return;
            
            // Configurar a duração da animação baseada no SCROLL_SPEED
            introText.style.animation = `scrollUp ${SCROLL_SPEED}s linear forwards`;
            
            // Configurar botões de controle do prólogo
            const skipButton = document.getElementById('skip-intro-button');
            const pauseButton = document.getElementById('pause-intro');
            const resumeButton = document.getElementById('resume-intro');
            
            if (skipButton) {
                skipButton.addEventListener('click', function() {
                    clearTimeout(textScrollTimeout);
                    showScreen('story-screen');
                    loadSection('intro');
                });
            }
            
            if (pauseButton) {
                pauseButton.addEventListener('click', pauseIntroText);
            }
            
            if (resumeButton) {
                resumeButton.addEventListener('click', resumeIntroText);
            }
            
            // Tempo para transição para a história
            textScrollTimeout = setTimeout(() => {
                showScreen('story-screen');
                loadSection('intro');
            }, (SCROLL_SPEED * 1000));
        }
        
        function pauseIntroText() {
            if (!introAnimationPaused) {
                const introText = document.getElementById('intro-text');
                const pauseButton = document.getElementById('pause-intro');
                const resumeButton = document.getElementById('resume-intro');
                
                if (introText) introText.style.animationPlayState = 'paused';
                if (pauseButton) pauseButton.style.display = 'none';
                if (resumeButton) resumeButton.style.display = 'inline-block';
                
                introAnimationPaused = true;
                
                // Pausar também o timeout para a próxima tela
                clearTimeout(textScrollTimeout);
            }
        }
        
        function resumeIntroText() {
            if (introAnimationPaused) {
                const introText = document.getElementById('intro-text');
                const pauseButton = document.getElementById('pause-intro');
                const resumeButton = document.getElementById('resume-intro');
                
                if (introText) introText.style.animationPlayState = 'running';
                if (resumeButton) resumeButton.style.display = 'none';
                if (pauseButton) pauseButton.style.display = 'inline-block';
                
                introAnimationPaused = false;
                
                // Estimativa simplificada do tempo restante
                const remainingTime = SCROLL_SPEED * 1000 * 0.7; // 70% do tempo total
                
                textScrollTimeout = setTimeout(() => {
                    showScreen('story-screen');
                    loadSection('intro');
                }, remainingTime);
            }
        }
        
        // -------------------- HANDLERS DA HISTÓRIA --------------------
        function loadSection(sectionId) {
            console.log(`Carregando seção: ${sectionId}`);
            
            currentSection = sectionId;
            const section = storyData[sectionId];
            
            if (!section) {
                console.error(`Seção ${sectionId} não encontrada!`);
                alert(`Erro: Seção ${sectionId} não encontrada. Usando seção de backup.`);
                
                // Criar uma seção de backup em tempo real
                storyData[sectionId] = {
                    text: `[Continuação da história] Você segue em frente, enfrentando os desafios da nave danificada. O tempo está se esgotando e as decisões se tornam cada vez mais cruciais.`,
                    options: [
                        { text: "Continuar explorando a nave", nextSection: "10" },
                        { text: "Verificar o setor de criogenia", nextSection: "20" },
                        { text: "Buscar o compartimento 772B", nextSection: "37" }
                    ]
                };
                
                return loadSection(sectionId); // Recursão com a nova seção criada
            }
            
            // Adicionar ao histórico
            if (section.text) {
                addToHistory(sectionId, section.text);
            }
            
            // Verificar se é uma seção especial (combate ou quebra-cabeça)
            if (section.type === 'combat') {
                setupCombat(section);
                return;
            } else if (section.type === 'puzzle') {
                setupPuzzle(section);
                return;
            }
            
            // Seção normal de história
            const sectionIdElem = document.getElementById('section-id');
            const storyText = document.getElementById('story-text');
            const optionsContainer = document.getElementById('options-container');
            
            if (sectionIdElem) sectionIdElem.textContent = `Seção ${sectionId}`;
            if (storyText) storyText.innerHTML = section.text.replace(/\n/g, '<br>');
            
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                
                if (section.options && section.options.length > 0) {
                    section.options.forEach(option => {
                        const button = document.createElement('button');
                        button.classList.add('option-button');
                        button.textContent = option.text;
                        button.addEventListener('click', () => {
                            console.log(`Clique em opção para seção: ${option.nextSection}`);
                            loadSection(option.nextSection);
                        });
                        optionsContainer.appendChild(button);
                    });
                } else {
                    console.warn(`A seção ${sectionId} não tem opções definidas.`);
                    // Adicionar opção padrão para avançar para a seção final
                    const button = document.createElement('button');
                    button.classList.add('option-button');
                    button.textContent = "Continuar para o final...";
                    button.addEventListener('click', () => {
                        loadSection("final");
                    });
                    optionsContainer.appendChild(button);
                }
            }
            
            showScreen('story-screen');
        }
        
        // -------------------- HANDLERS DE MENU --------------------
        function setupMenu() {
            const menuButton = document.getElementById('menu-button');
            const saveGame_btn = document.getElementById('save-game');
            const loadGame_btn = document.getElementById('load-game');
            const viewHistory = document.getElementById('view-history');
            const mainMenu = document.getElementById('main-menu');
            const backFromHistory = document.getElementById('back-from-history');
            
            if (menuButton) {
                menuButton.addEventListener('click', toggleMenu);
            }
            
            if (saveGame_btn) {
                saveGame_btn.addEventListener('click', function() {
                    saveGame();
                    toggleMenu();
                });
            }
            
            if (loadGame_btn) {
                loadGame_btn.addEventListener('click', function() {
                    loadGame();
                    toggleMenu();
                });
            }
            
            if (viewHistory) {
                viewHistory.addEventListener('click', function() {
                    showHistory();
                    toggleMenu();
                });
            }
            
            if (mainMenu) {
                mainMenu.addEventListener('click', function() {
                    if (confirm("Voltar ao menu principal? O progresso não salvo será perdido.")) {
                        showScreen('start-screen');
                    }
                    toggleMenu();
                });
            }

            if (backFromHistory) {
                backFromHistory.addEventListener('click', function() {
                    showScreen('story-screen');
                });
            }
            
            // Fechar menu ao clicar fora dele
            document.addEventListener('click', function(event) {
                if (menuOpen && !event.target.closest('.game-menu')) {
                    toggleMenu();
                }
            });
        }
        
        function toggleMenu() {
            const menuDropdown = document.getElementById('menu-dropdown');
            if (!menuDropdown) return;
            
            menuOpen = !menuOpen;
            
            if (menuOpen) {
                menuDropdown.classList.add('active');
            } else {
                menuDropdown.classList.remove('active');
            }
        }
        
        // -------------------- HANDLERS DE COMBATE --------------------
        function setupCombat(section) {
            const combat = section.combatData;
            if (!combat) return;
            
            const combatHeader = document.getElementById('combat-header');
            const enemyName = document.getElementById('enemy-name');
            const enemyInfo = document.getElementById('enemy-info');
            const characterHealth = document.getElementById('character-health');
            const enemyHealth = document.getElementById('enemy-health');
            const characterItems = document.getElementById('character-items');
            const actionsContainer = document.getElementById('combat-actions');
            const combatLog = document.getElementById('combat-log');
            
            // Verificar se todos os elementos existem
            if (!combatHeader || !enemyName || !enemyInfo || !characterHealth || 
                !enemyHealth || !characterItems || !actionsContainer || !combatLog) {
                console.error("Elementos de combate não encontrados");
                return;
            }
            
            // Configurar detalhes do combate
            combatHeader.textContent = "COMBATE";
            enemyName.textContent = combat.enemyName;
            enemyInfo.textContent = combat.enemyInfo;
            
            // Restaurar saúde
            characterHealth.style.width = '100%';
            enemyHealth.style.width = '100%';
            
            // Itens aleatórios do jogador
            const randomPlayerItems = [];
            for (let i = 0; i < 3; i++) {
                randomPlayerItems.push(getRandomItem(randomItems));
            }
            
            characterItems.innerHTML = `Arma: ${getRandomItem(randomWeapons)}<br>Itens: ${randomPlayerItems.join(', ')}`;
            
            // Configurar botões de ação
            actionsContainer.innerHTML = '';
            
            const actions = [
                { text: "Atacar", action: "attack" },
                { text: "Defender", action: "defend" },
                { text: `Usar ${randomPlayerItems[0]}`, action: "useItem1" },
                { text: `Usar ${randomPlayerItems[1]}`, action: "useItem2" },
                { text: `Usar ${randomPlayerItems[2]}`, action: "useItem3" }
            ];
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.classList.add('combat-button');
                button.textContent = action.text;
                button.addEventListener('click', () => performCombatAction(action.action, combat));
                actionsContainer.appendChild(button);
            });
            
            // Mostrar tela de combate
            showScreen('combat-screen');
            
            // Texto inicial do combate
            combatLog.innerHTML = section.text + '<br>Prepare-se para o combate!';
        }
        
        function performCombatAction(action, combat) {
            const log = document.getElementById('combat-log');
            const characterHealth = document.getElementById('character-health');
            const enemyHealth = document.getElementById('enemy-health');
            
            if (!log || !characterHealth || !enemyHealth) return;
            
            // Valores atuais de saúde
            let playerHealthValue = parseInt(characterHealth.style.width) || 100;
            let enemyHealthValue = parseInt(enemyHealth.style.width) || 100;
            
            let actionResult = '';
            let playerDamage = 0;
            let enemyDamage = 0;
            
            // Processar a ação do jogador
            switch(action) {
                case 'attack':
                    playerDamage = Math.floor(Math.random() * 30) + 10;
                    actionResult = `Você ataca o ${combat.enemyName}, causando ${playerDamage} de dano!`;
                    break;
                case 'defend':
                    actionResult = 'Você assume uma postura defensiva, reduzindo o dano recebido.';
                    break;
                case 'useItem1':
                case 'useItem2':
                case 'useItem3':
                    // Efeitos aleatórios para os itens
                    const effectType = Math.floor(Math.random() * 3);
                    if (effectType === 0) {
                        playerDamage = Math.floor(Math.random() * 40) + 20;
                        actionResult = `Você usa o item e causa ${playerDamage} de dano!`;
                    } else if (effectType === 1) {
                        playerHealthValue = Math.min(100, playerHealthValue + Math.floor(Math.random() * 30) + 10);
                        actionResult = 'Você usa o item para recuperar sua saúde!';
                    } else {
                        playerDamage = Math.floor(Math.random() * 20) + 5;
                        enemyDamage = Math.floor(Math.random() * 15) + 5;
                        actionResult = `Você usa o item causando ${playerDamage} de dano, mas sofre ${enemyDamage} de dano como efeito colateral!`;
                    }
                    break;
            }
            
            // Aplicar dano ao inimigo
            enemyHealthValue = Math.max(0, enemyHealthValue - playerDamage);
            enemyHealth.style.width = `${enemyHealthValue}%`;
            
            // Ação do inimigo (se ainda estiver vivo)
            if (enemyHealthValue > 0 && action !== 'defend') {
                const enemyAttackDamage = Math.floor(Math.random() * 25) + 5;
                playerHealthValue = Math.max(0, playerHealthValue - enemyAttackDamage);
                actionResult += `<br>${combat.enemyName} contra-ataca, causando ${enemyAttackDamage} de dano!`;
            } else if (enemyHealthValue > 0 && action === 'defend') {
                const reducedDamage = Math.floor(Math.random() * 15) + 1;
                playerHealthValue = Math.max(0, playerHealthValue - reducedDamage);
                actionResult += `<br>${combat.enemyName} ataca, mas sua defesa reduz o dano para ${reducedDamage}!`;
            }
            
            // Aplicar dano adicional ao jogador (de efeitos colaterais)
            playerHealthValue = Math.max(0, playerHealthValue - enemyDamage);
            characterHealth.style.width = `${playerHealthValue}%`;
            
            // Atualizar log de combate
            log.innerHTML += '<br>' + actionResult;
            log.scrollTop = log.scrollHeight;
            
            // Verificar fim do combate
            if (enemyHealthValue <= 0 || playerHealthValue <= 0) {
                const result = enemyHealthValue <= 0 ? 'victory' : 'defeat';
                let nextSection = 'final';
                
                if (combat.outcomes) {
                    const outcome = combat.outcomes.find(o => o.result === result);
                    if (outcome) nextSection = outcome.nextSection;
                }
                
                setTimeout(() => {
                    log.innerHTML += '<br><br>' + (result === 'victory' ? 'Você derrotou o inimigo!' : 'Você foi derrotado!');
                    
                    setTimeout(() => {
                        loadSection(nextSection);
                    }, 2000);
                }, 1000);
                
                // Desabilitar botões
                document.querySelectorAll('.combat-button').forEach(button => {
                    button.disabled = true;
                });
            }
        }
        
        // -------------------- HANDLERS DE QUEBRA-CABEÇA --------------------
        function setupPuzzle(section) {
            const puzzle = section.puzzleData;
            if (!puzzle) return;
            
            const puzzleHeader = document.getElementById('puzzle-header');
            const puzzleDescription = document.getElementById('puzzle-description');
            const puzzleContent = document.getElementById('puzzle-content');
            const puzzleOptions = document.getElementById('puzzle-options');
            
            if (!puzzleHeader || !puzzleDescription || !puzzleContent || !puzzleOptions) {
                console.error("Elementos de quebra-cabeça não encontrados");
                return;
            }
            
            puzzleHeader.textContent = puzzle.title;
            puzzleDescription.innerHTML = puzzle.description.replace(/\n/g, '<br>');
            puzzleContent.innerHTML = '';
            
            // Adicionar visualização específica para diferentes tipos de quebra-cabeças
            if (puzzle.title.includes("ROTEAMENTO DE ENERGIA")) {
                // Criar uma visualização de diagrama para o quebra-cabeça de energia
                const diagramSvg = document.createElement('div');
                diagramSvg.innerHTML = `
                    <svg width="300" height="200" viewBox="0 0 300 200">
                        <circle cx="50" cy="100" r="20" fill="#333" stroke="#00ff00" stroke-width="2"/>
                        <text x="50" y="105" text-anchor="middle" fill="#00ff00" font-size="16">A</text>
                        
                        <circle cx="150" cy="50" r="20" fill="#333" stroke="#00ff00" stroke-width="2"/>
                        <text x="150" y="55" text-anchor="middle" fill="#00ff00" font-size="16">B</text>
                        
                        <circle cx="150" cy="150" r="20" fill="#333" stroke="#00ff00" stroke-width="2"/>
                        <text x="150" y="155" text-anchor="middle" fill="#00ff00" font-size="16">C</text>
                        
                        <circle cx="250" cy="100" r="20" fill="#333" stroke="#00ff00" stroke-width="2"/>
                        <text x="250" y="105" text-anchor="middle" fill="#00ff00" font-size="16">D</text>
                        
                        <circle cx="200" cy="175" r="20" fill="#333" stroke="#00ff00" stroke-width="2"/>
                        <text x="200" y="180" text-anchor="middle" fill="#00ff00" font-size="16">E</text>
                        
                        <line x1="70" y1="100" x2="130" y2="50" stroke="#00ff00" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="70" y1="100" x2="130" y2="150" stroke="#00ff00" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="170" y1="50" x2="230" y2="100" stroke="#00ff00" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="170" y1="150" x2="230" y2="100" stroke="#00ff00" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="170" y1="150" x2="180" y2="175" stroke="#00ff00" stroke-width="2" stroke-dasharray="5,5"/>
                        <line x1="220" y1="175" x2="230" y2="100" stroke="#00ff00" stroke-width="2" stroke-dasharray="5,5"/>
                    </svg>
                `;
                puzzleContent.appendChild(diagramSvg);
            } else if (puzzle.title.includes("SEQUÊNCIA")) {
                // Criar um destaque visual para a sequência
                const sequenceHighlight = document.createElement('div');
                sequenceHighlight.style.fontSize = "1.5rem";
                sequenceHighlight.style.margin = "20px auto";
                sequenceHighlight.style.padding = "10px";
                sequenceHighlight.style.backgroundColor = "rgba(0, 0, 80, 0.5)";
                sequenceHighlight.style.borderRadius = "5px";
                sequenceHighlight.style.textAlign = "center";
                
                if (puzzle.description.includes("8, 27, ?, 125, 216")) {
                    sequenceHighlight.innerHTML = "8, 27, <strong style='color:#33ccff; font-size:2rem;'>?</strong>, 125, 216";
                } else {
                    sequenceHighlight.textContent = "Sequência desafiadora";
                }
                
                puzzleContent.appendChild(sequenceHighlight);
            } else if (puzzle.title.includes("CÓDIGO DE SEGURANÇA")) {
                // Criar um painel de entrada de código
                const codePanel = document.createElement('div');
                codePanel.style.width = "200px";
                codePanel.style.height = "50px";
                codePanel.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
                codePanel.style.border = "1px solid #33ccff";
                codePanel.style.borderRadius = "5px";
                codePanel.style.margin = "20px auto";
                codePanel.style.display = "flex";
                codePanel.style.justifyContent = "center";
                codePanel.style.alignItems = "center";
                codePanel.style.fontSize = "2rem";
                codePanel.style.color = "#33ccff";
                codePanel.style.letterSpacing = "10px";
                codePanel.innerHTML = "____";
                
                puzzleContent.appendChild(codePanel);
            }
            
            puzzleOptions.innerHTML = '';
            
            if (puzzle.options && puzzle.options.length > 0) {
                puzzle.options.forEach(option => {
                    const button = document.createElement('button');
                    button.classList.add('puzzle-button');
                    button.textContent = option.text;
                    button.addEventListener('click', () => {
                        // Efeito visual para feedback da escolha
                        if (option.correct) {
                            button.style.backgroundColor = "rgba(0, 100, 0, 0.9)";
                            button.style.boxShadow = "0 0 15px #00ff00";
                        } else {
                            button.style.backgroundColor = "rgba(100, 0, 0, 0.9)";
                            button.style.boxShadow = "0 0 15px #ff0000";
                        }
                        
                        setTimeout(() => {
                            loadSection(option.nextSection);
                        }, 800);
                    });
                    puzzleOptions.appendChild(button);
                });
            } else {
                // Opção de fallback
                const button = document.createElement('button');
                button.classList.add('puzzle-button');
                button.textContent = "Continuar...";
                button.addEventListener('click', () => {
                    loadSection("10"); // Voltar para uma seção segura
                });
                puzzleOptions.appendChild(button);
            }
            
            showScreen('puzzle-screen');
        }
        
        // -------------------- INICIALIZAÇÃO --------------------
        window.onload = function() {
            try {
                console.log("Inicializando o jogo...");
                
                // Adicionar seções de fallback automaticamente
                addFallbackSections();
                
                // Inicializar interface e eventos
                setupStartScreen();
                setupMenu();
                
                // Verificar se há um jogo salvo
                if (localStorage.getItem(SAVE_KEY)) {
                    const continueButton = document.getElementById('continue-button');
                    if (continueButton) continueButton.disabled = false;
                }
                
                console.log("Jogo inicializado com sucesso!");
            } catch (error) {
                console.error("Erro na inicialização do jogo:", error);
                alert("Ocorreu um erro ao inicializar o jogo. Verifique o console para mais detalhes.");
            }
        };
    </script>
</body>
</html>
